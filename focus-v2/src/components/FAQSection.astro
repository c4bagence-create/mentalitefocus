---
/**
 * FAQSection - "FAQ AI"
 * Interface de chat AI - Theme aware avec scroll fixe
 */

interface FAQItem {
  question: string;
  answer: string;
}

const faqData: FAQItem[] = [
  {
    question: "Je pars de 0, c'est pour moi ?",
    answer: "Focus est con√ßu pour <strong>tous les niveaux</strong>. Que tu sois d√©butant ou que tu aies d√©j√† de l'exp√©rience, tu trouveras des ressources adapt√©es. La majorit√© de nos membres ont commenc√© <strong>sans connaissances pr√©alables</strong>."
  },
  {
    question: "Pourquoi seulement 9.90‚Ç¨ ?",
    answer: "On croit que <strong>l'acc√®s au savoir ne devrait pas √™tre un luxe</strong>. √Ä ce prix, on rend l'apprentissage accessible √† tous. Tu acc√®des √† <strong>tout un √©cosyst√®me</strong> de ressources et d'entraide."
  },
  {
    question: "J'ai pas le temps, je travaille...",
    answer: "Justement ! Focus est pens√© pour les <strong>gens occup√©s</strong>. Pas de cours de 10h. Des <strong>ressources pratiques</strong> que tu consommes √† ton rythme. <strong>15 min/jour suffisent</strong> pour progresser."
  },
  {
    question: "C'est quoi exactement le contenu ?",
    answer: "Tu acc√®des √†: <strong>Le Coffre</strong> (templates, scripts, prompts IA). <strong>Lives hebdo</strong> sur diff√©rentes th√©matiques business. <strong>Discord priv√©</strong> avec +1200 membres. <strong>Experts disponibles</strong> dans 8 domaines."
  },
  {
    question: "IA & Automatisation, c'est quoi ?",
    answer: "On utilise <strong>ChatGPT, Claude, et des outils custom</strong> pour gagner du temps. Tu acc√®des √† nos <strong>prompts optimis√©s</strong> pour: cr√©er du contenu, organiser tes projets, automatiser des t√¢ches r√©p√©titives."
  },
  {
    question: "C'est pas un √©ni√®me Discord ?",
    answer: "Non. On a <strong>des r√®gles strictes</strong>. Pas de spam, pas de promos, pas de toxicit√©. Chaque membre est <strong>v√©rifi√©</strong>. <strong>C'est une vraie communaut√©</strong> d'entraide et de partage."
  },
  {
    question: "Je peux quitter quand je veux ?",
    answer: "<strong>Aucun engagement</strong>. Tu annules en 2 clics. Pas de frais cach√©s, pas de p√©riode minimum. La grande majorit√© de nos membres restent car ils y trouvent de la valeur."
  },
  {
    question: "Il y a une garantie ?",
    answer: "Oui ! <strong>Satisfait ou rembours√© 7 jours</strong>. Tu testes, tu explores, et si c'est pas pour toi, on te rembourse int√©gralement. Aucun risque."
  }
];

const categories = [
  { name: 'D√âMARRAGE', emoji: 'üöÄ', items: [0, 1, 2] },
  { name: 'CONTENU', emoji: 'üìö', items: [3, 4, 5] },
  { name: 'PRATIQUE', emoji: '‚öôÔ∏è', items: [6, 7] },
];
---

<section class="faq-section" id="faq">
  <!-- Glow effects -->
  <div class="glow glow-1" aria-hidden="true"></div>
  <div class="glow glow-2" aria-hidden="true"></div>
  <div class="glow glow-3" aria-hidden="true"></div>

  <!-- Header -->
  <header class="section-header">
    <div class="badge">
      <span class="badge-dot"></span>
      <span>Questions Fr√©quentes</span>
    </div>
    
    <h2 class="section-title">
      FAQ <span class="text-gradient">AI.</span>
    </h2>
    
    <p class="section-desc">
      <strong>L'intelligence collective</strong> √† votre service. 
      <strong class="gold">24/7.</strong>
    </p>
  </header>

  <!-- Chat Interface -->
  <div class="chat-wrapper">
    <div class="beam-container" aria-hidden="true">
      <div class="beam"></div>
    </div>
    
    <div class="chat-interface">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="ai-profile">
          <span class="ai-avatar">F</span>
          <div class="ai-info">
            <span class="ai-name">Focus Assistant</span>
            <span class="ai-status">
              <span class="status-dot"></span>
              ONLINE
            </span>
          </div>
        </div>

        <nav class="questions-nav">
          {categories.map(cat => (
            <div class="category">
              <span class="category-title">{cat.name}</span>
              {cat.items.map(idx => (
                <button 
                  class="question-btn" 
                  data-question={idx}
                  type="button"
                >
                  <span class="q-emoji">{['üöÄ', 'üí∏', '‚è≥', 'üìö', 'ü§ñ', 'üåê', 'üîì', 'üéÅ'][idx]}</span>
                  <span class="q-text">{faqData[idx].question.substring(0, 25)}...</span>
                </button>
              ))}
            </div>
          ))}
        </nav>
      </aside>

      <!-- Chat Area -->
      <main class="chat-main">
        <div class="messages-container" id="messages-container">
          <div class="welcome-message">
            <span class="welcome-icon">ü§ñ</span>
            <div class="welcome-content">
              <h3>Bienvenue dans la FAQ Focus</h3>
              <p>Clique sur une question pour obtenir une r√©ponse instantan√©e.</p>
            </div>
          </div>
        </div>
        
        <div class="input-area">
          <input 
            type="text" 
            class="chat-input" 
            id="chat-input"
            placeholder="Pose ta question..." 
          />
          <button class="send-button" id="send-button" type="button">
            <span>‚Üí</span>
          </button>
        </div>
      </main>
    </div>
  </div>
</section>

<style>
  .faq-section {
    position: relative;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 1.25rem;
    background: var(--bg-section);
  }

  /* Glows */
  .glow {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    filter: blur(120px);
  }

  .glow-1 {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 800px;
    height: 800px;
    background: var(--gold-glow);
    opacity: 0.3;
  }

  .glow-2 {
    top: 0;
    left: 0;
    width: 400px;
    height: 400px;
    background: var(--gold-glow);
    opacity: 0.2;
  }

  .glow-3 {
    bottom: 0;
    right: 0;
    width: 500px;
    height: 500px;
    background: var(--gold-glow);
    opacity: 0.15;
  }

  /* Header */
  .section-header {
    text-align: center;
    margin-bottom: 3rem;
    position: relative;
    z-index: 10;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 1rem;
    border-radius: 9999px;
    border: 1px solid var(--border-medium);
    background: var(--bg-card);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
  }

  .badge-dot {
    width: 0.5rem;
    height: 0.5rem;
    background: var(--gold);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
  }

  .section-title {
    font-size: clamp(2.5rem, 8vw, 5rem);
    font-weight: 900;
    line-height: 0.9;
    color: var(--text-primary);
  }

  .text-gradient {
    background: linear-gradient(180deg, var(--gold-light), var(--gold), var(--gold-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .section-desc {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 1rem;
  }

  .section-desc strong {
    color: var(--text-primary);
  }

  .section-desc .gold {
    color: var(--gold);
  }

  /* Chat Wrapper */
  .chat-wrapper {
    position: relative;
    max-width: 1000px;
    margin: 0 auto;
  }

  .beam-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
    z-index: 0;
  }

  .beam {
    width: 100%;
    height: 100px;
    background: linear-gradient(180deg, transparent, var(--gold), transparent);
    animation: beamMove 3s ease-in-out infinite;
  }

  @keyframes beamMove {
    0% { transform: translateY(-100px); }
    100% { transform: translateY(600px); }
  }

  /* Chat Interface */
  .chat-interface {
    display: flex;
    flex-direction: column;
    background: var(--bg-card);
    border: 1px solid var(--border-medium);
    border-radius: 1.25rem;
    overflow: hidden;
    position: relative;
    z-index: 10;
  }

  @media (min-width: 768px) {
    .chat-interface {
      flex-direction: row;
      height: 500px;
    }
  }

  /* Sidebar */
  .sidebar {
    width: 100%;
    background: var(--bg-card-elevated);
    border-bottom: 1px solid var(--border-light);
    padding: 1.25rem;
  }

  @media (min-width: 768px) {
    .sidebar {
      width: 280px;
      border-bottom: none;
      border-right: 1px solid var(--border-light);
      flex-shrink: 0;
      overflow-y: auto;
    }
  }

  .ai-profile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 1rem;
  }

  .ai-avatar {
    width: 2.5rem;
    height: 2.5rem;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 900;
    color: black;
  }

  .ai-name {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text-primary);
    display: block;
  }

  .ai-status {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.625rem;
    font-weight: 700;
    color: var(--gold);
    margin-top: 0.125rem;
  }

  .status-dot {
    width: 0.375rem;
    height: 0.375rem;
    background: var(--gold);
    border-radius: 50%;
    animation: pulse 1s infinite;
    box-shadow: 0 0 10px var(--gold);
  }

  .questions-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    max-height: 250px;
    overflow-y: auto;
  }

  @media (min-width: 768px) {
    .questions-nav {
      max-height: none;
    }
  }

  .category {
    margin-bottom: 0.5rem;
  }

  .category-title {
    font-size: 0.5625rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: block;
    margin-bottom: 0.25rem;
  }

  .question-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.625rem 0.75rem;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .question-btn:hover {
    background: var(--gold-bg);
    border-color: color-mix(in srgb, var(--gold) 20%, transparent);
    color: var(--text-primary);
  }

  .question-btn.active {
    background: var(--gold-bg);
    border-color: color-mix(in srgb, var(--gold) 30%, transparent);
    color: var(--gold);
  }

  .q-emoji {
    font-size: 0.875rem;
  }

  .q-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Chat Main */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 350px;
  }

  @media (min-width: 768px) {
    .chat-main {
      min-height: auto;
    }
  }

  .messages-container {
    flex: 1;
    padding: 1.25rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 380px;
    scrollbar-width: thin;
    scrollbar-color: var(--border-medium) transparent;
  }

  .messages-container::-webkit-scrollbar {
    width: 4px;
  }

  .messages-container::-webkit-scrollbar-thumb {
    background: var(--border-medium);
    border-radius: 2px;
  }

  .welcome-message {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--gold-bg);
    border: 1px solid color-mix(in srgb, var(--gold) 10%, transparent);
    border-radius: 0.75rem;
  }

  .welcome-icon {
    font-size: 2rem;
  }

  .welcome-content h3 {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .welcome-content p {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin: 0;
  }

  /* Messages */
  .message {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    font-size: 0.8125rem;
    line-height: 1.5;
    animation: messageIn 0.3s ease;
  }

  @keyframes messageIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user {
    margin-left: auto;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: black;
    border-bottom-right-radius: 0.25rem;
  }

  .message.ai {
    background: var(--bg-input);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    border-bottom-left-radius: 0.25rem;
  }

  .message.ai :global(strong) {
    color: var(--gold);
  }

  .typing-indicator {
    display: flex;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border-light);
    border-radius: 1rem;
    border-bottom-left-radius: 0.25rem;
    width: fit-content;
  }

  .typing-indicator span {
    width: 0.375rem;
    height: 0.375rem;
    background: var(--gold);
    border-radius: 50%;
  }

  .typing-cursor {
    color: var(--gold);
    animation: cursorBlink 0.8s infinite;
    animation: typing 1.4s infinite;
  }

  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1); }
  }

  @keyframes cursorBlink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  /* Input Area */
  .input-area {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: var(--bg-card-elevated);
    border-top: 1px solid var(--border-light);
  }

  .chat-input {
    flex: 1;
    padding: 0.75rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border-light);
    border-radius: 0.75rem;
    font-size: 0.8125rem;
    color: var(--text-primary);
    outline: none;
    transition: border-color 0.2s;
  }

  .chat-input::placeholder {
    color: var(--text-muted);
  }

  .chat-input:focus {
    border-color: color-mix(in srgb, var(--gold) 50%, transparent);
  }

  .send-button {
    width: 2.75rem;
    height: 2.75rem;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    border: none;
    border-radius: 0.75rem;
    color: black;
    font-size: 1.125rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .send-button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px var(--gold-glow);
  }
</style>

<script define:vars={{ faqData }}>
  document.addEventListener('DOMContentLoaded', () => {
    const messagesContainer = document.getElementById('messages-container');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const questionBtns = document.querySelectorAll('.question-btn');
    let isTyping = false;

    // Add user message immediately
    const addUserMessage = (content) => {
      const msg = document.createElement('div');
      msg.className = 'message user';
      msg.innerHTML = content;
      messagesContainer.appendChild(msg);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    // Type AI message character by character
    const typeAIMessage = (htmlContent, callback) => {
      isTyping = true;
      
      // Create message container
      const msg = document.createElement('div');
      msg.className = 'message ai';
      messagesContainer.appendChild(msg);

      // Create a temp div to parse HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      const plainText = tempDiv.textContent || '';

      // Parse HTML tags
      const tagRegex = /<[^>]+>/g;
      const tags = htmlContent.match(tagRegex) || [];
      let tagIndex = 0;
      let htmlIndex = 0;
      let charIndex = 0;

      const typeChar = () => {
        if (charIndex >= plainText.length) {
          isTyping = false;
          if (callback) callback();
          return;
        }

        // Check if we need to add an HTML tag
        const currentHtmlPos = htmlContent.indexOf(plainText[charIndex], htmlIndex);
        const tagBeforePos = htmlContent.substring(htmlIndex, currentHtmlPos);
        
        // Handle HTML structure - simplified approach
        const currentChar = plainText[charIndex];
        
        // Build content with cursor
        let displayHtml = '';
        const processedText = plainText.substring(0, charIndex + 1);
        
        // Reconstruct HTML with typed text
        let textIdx = 0;
        let result = '';
        let inTag = false;
        
        for (let i = 0; i < htmlContent.length && textIdx <= charIndex; i++) {
          if (htmlContent[i] === '<') {
            inTag = true;
          }
          
          if (inTag) {
            result += htmlContent[i];
            if (htmlContent[i] === '>') {
              inTag = false;
            }
          } else {
            if (textIdx <= charIndex) {
              result += htmlContent[i];
              textIdx++;
            }
          }
        }
        
        // Close any unclosed tags
        const openTags = result.match(/<([a-z]+)[^>]*>/gi) || [];
        const closeTags = result.match(/<\/[a-z]+>/gi) || [];
        
        msg.innerHTML = result + '<span class="typing-cursor">|</span>';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        charIndex++;
        
        // Typing speed variation
        const speed = currentChar === '.' || currentChar === '!' || currentChar === '?' 
          ? 150 + Math.random() * 100 
          : 15 + Math.random() * 25;
        
        setTimeout(typeChar, speed);
      };

      // Start typing after brief delay
      setTimeout(typeChar, 200);
    };

    const showTyping = () => {
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.id = 'typing';
      typing.innerHTML = '<span></span><span></span><span></span>';
      messagesContainer.appendChild(typing);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    const hideTyping = () => {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    };

    const askQuestion = (index) => {
      if (isTyping) return; // Prevent spam
      
      const faq = faqData[index];
      if (!faq) return;

      // Remove welcome message
      const welcome = messagesContainer.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      // Update active button
      questionBtns.forEach(btn => btn.classList.remove('active'));
      questionBtns[index]?.classList.add('active');

      // Add user message
      addUserMessage(faq.question);

      // Show typing briefly then type response
      showTyping();

      setTimeout(() => {
        hideTyping();
        typeAIMessage(faq.answer);
      }, 500 + Math.random() * 300);
    };

    // Button clicks
    questionBtns.forEach((btn, idx) => {
      btn.addEventListener('click', () => {
        const qIndex = parseInt(btn.getAttribute('data-question') || '0');
        askQuestion(qIndex);
      });
    });

    // Custom input
    const handleCustomInput = () => {
      if (isTyping) return;
      
      const value = chatInput.value.trim();
      if (!value) return;

      // Remove welcome
      const welcome = messagesContainer.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      addUserMessage(value);
      chatInput.value = '';

      showTyping();

      setTimeout(() => {
        hideTyping();
        typeAIMessage("Excellente question ! Pour une r√©ponse personnalis√©e, <strong>rejoins Focus</strong> et pose ta question directement √† la communaut√©. Tu auras des r√©ponses d'experts en moins de 5 min. üöÄ");
      }, 600);
    };

    sendButton.addEventListener('click', handleCustomInput);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleCustomInput();
    });
  });
</script>
