---
import '../styles/global.css'

interface Props {
  title: string;
  description?: string;
  canonical?: string;
}

const siteUrl = "https://mentalite-focus.com";
const siteName = "Focus Business";
const defaultTitle = "Focus Business | Club Privé pour Entrepreneurs E-commerce & SMMA";
const defaultDescription = "Rejoins la communauté #1 des entrepreneurs e-commerce, dropshipping, SMMA et business en ligne. +1240 membres actifs, experts dédiés, Discord privé. Pour seulement 9.90€/mois.";
const defaultKeywords = "club business, groupe business, formation ecommerce, communauté entrepreneurs, dropshipping france, smma formation, business en ligne, ecommerce formation, club entrepreneur, groupe entrepreneur, formation shopify, formation ads, meta ads, tiktok ads, communauté ecommerce, mentoring business, coaching entrepreneur, discord business, groupe privé entrepreneur, formation business en ligne";
const defaultImage = `${siteUrl}/og-image.jpg`;

const { 
  title = defaultTitle, 
  description = defaultDescription,
  canonical = siteUrl
} = Astro.props;
---

<!doctype html>
<html lang="fr" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- SEO Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="keywords" content={defaultKeywords} />
    <meta name="author" content="Focus Business" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="French" />
    <meta name="revisit-after" content="7 days" />
    <meta name="theme-color" content="#000000" />
    <link rel="canonical" href={canonical} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={defaultImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="fr_FR" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonical} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={defaultImage} />
    
    <!-- Meta Domain Verification -->
    <meta name="facebook-domain-verification" content="v3o0xh2rtjxcq6t3bashmawguip8la" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.svg" />
    
    <!-- Preconnect -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Focus Business",
      "url": siteUrl,
      "logo": `${siteUrl}/favicon.svg`,
      "description": defaultDescription,
      "sameAs": [
        "https://discord.gg/focus-business"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "availableLanguage": "French"
      },
      "offers": {
        "@type": "Offer",
        "name": "Accès Focus Business",
        "price": "9.90",
        "priceCurrency": "EUR",
        "availability": "https://schema.org/InStock"
      }
    })} />
    
    <!-- Theme Script - Avant le rendu pour éviter le flash -->
    <script is:inline>
      // Appliquer le thème immédiatement
      (function() {
        const theme = localStorage.getItem('focus-theme') || 'light';
        document.documentElement.classList.toggle('dark', theme === 'dark');
        document.documentElement.classList.toggle('light', theme === 'light');
      })();
    </script>
    
    <!-- Meta Pixel Code -->
    <script is:inline>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '26364309749823828');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=26364309749823828&ev=PageView&noscript=1"/></noscript>
    
    <!-- Klaviyo -->
    <script async type='text/javascript' src='https://static.klaviyo.com/onsite/js/SRshwY/klaviyo.js?company_id=SRshwY'></script>
    <script is:inline type="text/javascript">
      //Initialize Klaviyo object on page load
      !function(){if(!window.klaviyo){window._klOnsite=window._klOnsite||[];try{window.klaviyo=new Proxy({},{get:function(n,i){return"push"===i?function(){var n;(n=window._klOnsite).push.apply(n,arguments)}:function(){for(var n=arguments.length,o=new Array(n),w=0;w<n;w++)o[w]=arguments[w];var t="function"==typeof o[o.length-1]?o.pop():void 0,e=new Promise((function(n){window._klOnsite.push([i].concat(o,[function(i){t&&t(i),n(i)}]))}));return e}}})}catch(n){window.klaviyo=window.klaviyo||[],window.klaviyo.push=function(){var n;(n=window._klOnsite).push.apply(n,arguments)}}}}();
    </script>
    
    <!-- Snapchat Pixel Code -->
    <script is:inline type="text/javascript">
      (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function()
      {a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};
      a.queue=[];var s='script';r=t.createElement(s);r.async=!0;
      r.src=n;var u=t.getElementsByTagName(s)[0];
      u.parentNode.insertBefore(r,u);})(window,document,
      'https://sc-static.net/scevent.min.js');
      snaptr('init', '827ae1c2-5cf7-44db-9761-0a858ab2e2e6');
      snaptr('track', 'PAGE_VIEW');
    </script>
    
    <!-- Microsoft Clarity -->
    <script is:inline type="text/javascript">
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "v50k153mjn");
    </script>
  </head>
  
  <body class="bg-page text-primary antialiased overflow-x-hidden">
    <!-- Global Gold Particles (très discret) -->
    <div class="global-particles" aria-hidden="true">
      <span class="gp"></span><span class="gp"></span><span class="gp"></span>
      <span class="gp"></span><span class="gp"></span><span class="gp"></span>
      <span class="gp"></span><span class="gp"></span><span class="gp"></span>
      <span class="gp"></span><span class="gp"></span><span class="gp"></span>
    </div>
    
    <slot />
    
    <!-- GSAP + ScrollTrigger -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    
    <!-- VanillaTilt -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    
    <!-- Smart Animations & Performance -->
    <script is:inline>
      // ========================================
      // PERFORMANCE MANAGER - Gestion centralisée
      // ========================================
      window.FocusPerf = {
        intervals: new Map(),
        observers: new Map(),
        
        // Créer un interval qui se pause quand hors viewport
        createSmartInterval: function(sectionId, callback, delay) {
          const section = document.getElementById(sectionId);
          if (!section) return null;
          
          let intervalId = null;
          
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                if (!intervalId) {
                  intervalId = setInterval(callback, delay);
                  this.intervals.set(sectionId + '_' + Date.now(), intervalId);
                }
              } else {
                if (intervalId) {
                  clearInterval(intervalId);
                  intervalId = null;
                }
              }
            });
          }, { rootMargin: '50px' });
          
          observer.observe(section);
          this.observers.set(sectionId, observer);
          
          return intervalId;
        },
        
        // Nettoyer tous les intervals d'une section
        clearSectionIntervals: function(sectionId) {
          this.intervals.forEach((id, key) => {
            if (key.startsWith(sectionId)) {
              clearInterval(id);
              this.intervals.delete(key);
            }
          });
        }
      };

      // ========================================
      // SCROLL ANIMATIONS - Ultra stylées
      // ========================================
      document.addEventListener('DOMContentLoaded', () => {
        // Animation types avec leurs transforms initiaux
        const animationTypes = {
          'fade-up': { transform: 'translateY(60px)', opacity: '0' },
          'fade-down': { transform: 'translateY(-60px)', opacity: '0' },
          'fade-left': { transform: 'translateX(-60px)', opacity: '0' },
          'fade-right': { transform: 'translateX(60px)', opacity: '0' },
          'fade-scale': { transform: 'scale(0.8)', opacity: '0' },
          'fade-rotate': { transform: 'rotate(-5deg) scale(0.9)', opacity: '0' },
          'zoom-in': { transform: 'scale(0.5)', opacity: '0' },
          'flip-up': { transform: 'perspective(1000px) rotateX(30deg)', opacity: '0' },
        };

        // Sélectionner tous les éléments animables
        const animatedElements = document.querySelectorAll('[data-animate]');
        
        // Appliquer les styles initiaux
        animatedElements.forEach(el => {
          const type = el.dataset.animate || 'fade-up';
          const delay = el.dataset.delay || '0';
          const duration = el.dataset.duration || '0.8';
          const styles = animationTypes[type] || animationTypes['fade-up'];
          
          el.style.opacity = styles.opacity;
          el.style.transform = styles.transform;
          el.style.transition = `all ${duration}s cubic-bezier(0.16, 1, 0.3, 1) ${delay}s`;
          el.style.willChange = 'transform, opacity';
        });

        // Observer pour déclencher les animations
        const scrollObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = '1';
              entry.target.style.transform = 'translateY(0) translateX(0) scale(1) rotate(0deg) rotateX(0deg)';
              entry.target.classList.add('animated');
              
              // Optionnel: arrêter d'observer après animation
              // scrollObserver.unobserve(entry.target);
            }
          });
        }, { 
          threshold: 0.1, 
          rootMargin: '0px 0px -80px 0px' 
        });

        animatedElements.forEach(el => scrollObserver.observe(el));

        // Stagger animation pour les groupes
        document.querySelectorAll('[data-stagger]').forEach(container => {
          const children = container.querySelectorAll('[data-stagger-item]');
          const baseDelay = parseFloat(container.dataset.stagger) || 0.1;
          
          children.forEach((child, index) => {
            child.style.opacity = '0';
            child.style.transform = 'translateY(40px)';
            child.style.transition = `all 0.6s cubic-bezier(0.16, 1, 0.3, 1) ${index * baseDelay}s`;
          });

          const staggerObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const items = entry.target.querySelectorAll('[data-stagger-item]');
                items.forEach(item => {
                  item.style.opacity = '1';
                  item.style.transform = 'translateY(0)';
                });
              }
            });
          }, { threshold: 0.2 });

          staggerObserver.observe(container);
        });

        // Parallax simple pour certains éléments
        const parallaxElements = document.querySelectorAll('[data-parallax]');
        if (parallaxElements.length > 0 && window.innerWidth > 768) {
          window.addEventListener('scroll', () => {
            const scrollY = window.scrollY;
            parallaxElements.forEach(el => {
              const speed = parseFloat(el.dataset.parallax) || 0.5;
              const rect = el.getBoundingClientRect();
              if (rect.top < window.innerHeight && rect.bottom > 0) {
                el.style.transform = `translateY(${scrollY * speed * 0.1}px)`;
              }
            });
          }, { passive: true });
        }

        // Init VanillaTilt on cards (desktop only for perf)
        if (typeof VanillaTilt !== 'undefined' && window.innerWidth > 768) {
          VanillaTilt.init(document.querySelectorAll("[data-tilt]"), {
            max: 6,
            speed: 400,
            glare: true,
            "max-glare": 0.1,
            scale: 1.01
          });
        }
      });
      
      // Page visibility - pause ALL animations when tab inactive
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Pause all intervals
          window.FocusPerf.intervals.forEach((id) => clearInterval(id));
          window.FocusPerf.intervals.clear();
          // Pause CSS animations
          document.body.style.setProperty('--global-animation-state', 'paused');
        } else {
          document.body.style.setProperty('--global-animation-state', 'running');
        }
      });
      
      // Theme toggle function
      window.toggleTheme = function() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        
        html.classList.toggle('dark', !isDark);
        html.classList.toggle('light', isDark);
        localStorage.setItem('focus-theme', isDark ? 'light' : 'dark');
      };

      // Performance: Pause animations when not visible
      const animObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-view');
            // Dispatch custom event for JS animations
            entry.target.dispatchEvent(new CustomEvent('section-visible'));
          } else {
            entry.target.classList.remove('in-view');
            entry.target.dispatchEvent(new CustomEvent('section-hidden'));
          }
        });
      }, { rootMargin: '100px' });

      document.querySelectorAll('section').forEach(section => {
        section.classList.add('pause-when-hidden');
        animObserver.observe(section);
      });
    </script>
  </body>
</html>
